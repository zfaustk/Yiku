/*pub-1|2013-05-17 20:32:29*/KISSY.add("tml/review/list",function(f,h,c,b,e){var d={};var g=true;d.mm=function(i){new Image().src="http://log.mmstat.com/tmallrate."+i};d.publicize={bool:true,txt:'5\u670820-5\u670829\u65e5\u671f\u95f4,\u8ba4\u771f\u5199\u8bc4\u4ef7\u5c31\u6709\u673a\u4f1a\u8d62\u5f97500\u4e07\u5f69\u7968\u5927\u5956\uff01<div class="pubmore"><span class="ui-msg-question"><span class="ui-msg-icon"></span></span><a href="http://www.tmall.com/go/act/sale/xpjscp.php?ad_id=&am_id=1301056723b1ff6c5c00&cm_id=&pm_id=" target="_blank">\u67e5\u770b\u6d3b\u52a8\u8be6\u60c5</a></div>'};d.setPublicize=function(){if(this.publicize.bool&&document.location.href.indexOf("rate_detail")==-1){var i=this.publicize.txt!=""?this.publicize.txt:"\u6d3b\u52a8\u4fe1\u606f<a>\u6d3b\u52a8\u4fe1\u606f</a>";var j='<div class="publicize">'+i+"</div>";f.all(j).insertBefore("div.rate-toolbar")}};d.init=function(l,j,m){var i=this;l=h.get(l);i.config=j;if(m!=undefined){g=m}else{i.publicize.bool=false}i.queryvars={itemId:j.itemId,spuId:j.spuId,sellerId:j.sellerId,order:1,currentPage:1,append:0,content:1,tagId:"",posi:""};i.headerEl=h.get("div.rate-header",l);i.subjectEl=h.get("div.rate-subject",l);i.toolbarEl=h.get("div.rate-toolbar",l);i.gridEl=h.get("div.rate-grid",l);i.pageEl=h.get("div.rate-page",l);i.toolbarEl.innerHTML=i.renderToolbar();var k=h.query("a",h.get("span.rate-sort",i.toolbarEl));c.on(k,"click",function(n){n.halt();i.queryvars.order=h.attr(this,"data-value");i.queryvars.currentPage=1;i.request();h.removeClass(k,"active");h.addClass(this,"active")});c.on(h.query("input",h.get("span.rate-filter",i.toolbarEl)),"click",function(){i.resetQueryvars();i.queryvars[this.name]=this.checked?1:0;if("append"===this.name){i.queryvars.tagId="";i.queryvars.posi=""}i.request()});if(j.listLoader){j.listLoader(function(n){i.render(n)})}else{i.request()}if(j.tagLoader){j.tagLoader(function(n){i.renderTags(n)})}else{i.requestTags()}if(j.scoreLoader){j.scoreLoader(function(n){i.renderScore(n)})}i.setPublicize()};d.resetQueryvars=function(){this.queryvars.currentPage=1};d.renderScore=function(j){var k=f.isPlainObject(j)?j.gradeAvg:0;k=k||0;var i='<div class="rate-score">';i+="<h4>\u4e0e\u63cf\u8ff0\u76f8\u7b26</h4>";i+="<strong>"+k+"</strong>";i+='<p><span class="score-value-no score-value-'+(""+k).replace(".","d")+'"><em></em></span></p>';i+="</div>";i+='<div class="rate-graph">';i+='<div class="graph-scroller"><span style="width:'+(k*20)+'%"><em>'+k+"</em></span></div>";i+='<ol class="graph-desc"><li>\u975e\u5e38\u4e0d\u6ee1</li><li>\u4e0d\u6ee1\u610f</li><li>\u4e00\u822c</li><li>\u6ee1\u610f</li><li>\u975e\u5e38\u6ee1\u610f</li></ol>';h.prepend(h.create(i),this.headerEl);h.css(this.headerEl,"display","block")};d.request=function(k,l){var i=this;var j="http://rate."+(i.config.daily?"daily.tmall.net":"tmall.com")+"/list_detail_rate.htm";if(f.isFunction(k)){l=k;k={}}b.jsonp(j,f.merge(i.queryvars,k),function(m){i.render(f.isPlainObject(m)?m.rateDetail:null);if(f.isFunction(l)){l()}})};d.requestTags=function(){var i=this;var j="http://rate."+(i.config.daily?"daily.tmall.net":"tmall.com")+"/listTagClouds.htm";b.jsonp(j,{itemId:i.config.itemId,isAll:true,isInner:!i.config.hasCompose,t:f.now()},function(k){i.renderTags(k)})};d.render=function(k){if(!k){return}var i=this;var j="";if(1===i.queryvars.append){h.removeClass(i.curTagEl,"selected");i.curTagEl=null}if(i.queryvars.tagId){h.attr(h.get("input.rate-list-append",i.toolbarEl),"checked",false)}i.applyDanceInfo(k);f.each(k.rateList,function(l){j+=i.renderOneComment(l)});this.detachEvents();this.gridEl.innerHTML="<table><tbody>"+j+"</tbody></table>";this.pageEl.innerHTML=this.renderPage(k.paginator);f.each(h.query("div.rate-fulltxt",this.gridEl),function(o){if(h.outerHeight(o)<=190){return}var n=o.parentNode;var m=h.create('<div class="rate-full-trigger"></div>',{html:"<span></span>"});var l=h.get("span",m);h.insertAfter(m,n);c.on(l,"click",function(){var p=h.hasClass(n,"rate-content-collapse");this.title=p?"\u6536\u8d77\u5168\u6587":"\u5c55\u5f00\u5168\u6587";h[p?"removeClass":"addClass"](this,"rate-collapse");h[p?"removeClass":"addClass"](n,"rate-content-collapse");h[p?"addClass":"removeClass"](n,"rate-content-expand")});c.fire(l,"click")});this.initListEvents();this.renderAppendCount(k.rateCount)};d.renderAppendCount=function(i){this.renderAppendCount=function(){};i=i||{};if(i.used){h.html(h.next(h.get("input.rate-list-append",this.toolbarEl)),"\u67e5\u770b\u8ffd\u52a0 ("+i.used+")")}};d.renderOneComment=function(i){return'<tr><td class="col-master">'+this.renderMaster(i)+'</td><td class="col-meta">'+this.renderMeta(i)+'</td><td class="col-author">'+this.renderAuthor(i)+"</td></tr>"};d.prependComment=function(i,k){var j=h.create(this.renderOneComment(i));h.remove(h.get("div.rate-empty",this.gridEl));h.prepend(j,h.get("tbody",this.gridEl));h.addClass(j,"rate-new");(new e(j,{opacity:1},1,"easeOut",function(){setTimeout(function(){h.removeClass(j,"rate-new")},5000);if(f.isFunction(k)){k(j)}})).run()};d.parseDate=function(k){if(!k.getTime()){return""}this.serverYearStr=k.getFullYear()+".";var j=k.getMonth()+1;if(j<10){j="0"+j}var i=k.getDate();if(i<10){i="0"+i}this.serverTime=this.serverYearStr+j+"."+i};d.applyDanceInfo=function(k){var i=this;var j=k.rateDanceInfo||{};i.parseDate(new Date(j.currentMilles));i.applyDanceInfo=function(){}};d.renderPage=function(o){if(!f.isPlainObject(o)||!o.lastPage){return""}var l="";var n=o.lastPage;if(n>0){l+='<div class="rate-paginator">';var p=o.page;if(p>1){l+='<a data-page="'+(p-1)+'" href="?page='+(p-1)+'">&lt;&lt;\u4e0a\u4e00\u9875</a>'}else{l+='<span class="rate-page-prev">&lt;&lt;\u4e0a\u4e00\u9875</span>'}var q=Math.max(1,p-2);var j=Math.min(n,p+2);if(p<5){q=1}else{if(q>1){l+='<a href="?page=1">1</a>'}if(q>2){l+='<a href="?page=2">2</a>'}if(q>3){l+='<span class="rate-page-break">...</span>'}}for(var k=q;k<=j;k++){if(k===p){l+="<span>"+k+"</span>"}else{l+='<a href="?page='+k+'">'+k+"</a>"}}var m=n-j;if(n-j>1){l+='<span class="rate-page-break">...</span>'}if(p===n){l+='<span class="rate-page-next">\u4e0b\u4e00\u9875&gt;&gt;</span>'}else{l+='<a data-page="'+(p+1)+'" href="?page='+(p+1)+'">\u4e0b\u4e00\u9875&gt;&gt;</a>'}l+="</div>"}return l};d.renderMaster=function(j){var k=this.renderComment(j);var l=j.rateDate.substr(0,10).replace(/-/g,".");if(l===this.serverTime){l="\u4eca\u5929"}else{if(l.indexOf(this.serverYearStr)>-1){l=l.substr(5)}}k+='<div class="rate-date">'+l+"</div>";var i=j.appendComment;if(i){k+='<div class="rate-append">'+this.renderComment({rateContent:i.content,diff:i.days,reply:i.reply})+"<s></s></div>"}return k};d.renderComment=function(j){var l="";var n=j.rateContent;var i=j.serviceRateContent;var k=n&&i;var m=j.reply;if(!n&&!i){n="\u6b64\u7528\u6237\u6ca1\u6709\u586b\u5199\u8bc4\u8bba\uff01"}if(n){var o="";if("diff" in j){o='<span class="rate-daydiff">'+(j.diff?(j.diff+"\u5929\u540e"):"\u5f53\u5929")+"\u8ffd\u52a0\uff1a</span>"}l+='<div class="rate-content"><div class="rate-fulltxt">'+(k?"<span>\u5546\u54c1\uff1a</span>":"")+o+a(n)+"</div></div>"}if(i){l+='<div class="rate-content"><div class="rate-fulltxt">'+(k?"<span>\u670d\u52a1\uff1a</span>":"")+a(i)+"</div></div>"}if(m){l+='<div class="rate-reply"><div class="rate-fulltxt">\u89e3\u91ca\uff1a'+a(m)+"</div></div>"}return l};d.renderAttrStr=function(j){var i="";f.each((j||"").split(";"),function(k){k=k.split(":");if(2===k.length){i+='<p title="'+k[0]+":"+k[1]+'"><span>'+k[0]+"\uff1a</span>"+k[1]+"</p>"}else{i+='<p title="'+k[0]+'">'+k[0]+"</p>"}});return i};d.renderMeta=function(j){var k="";var i=this.renderAttrStr(j.auctionSku);if(i){k+='<div class="rate-sku">'+i+"</div>"}var l=this.renderAttrStr(j.userInfo);if(l){k+='<div class="rate-user-profile">'+l+"</div>"}return k};d.renderAuthor=function(i){var j='<div class="rate-user-info">';if(i.displayUserNumId){j+='<a target="_blank" href="'+i.displayUserLink+'">'+i.displayUserNick+"</a>"}else{j+=i.displayUserNick.replace("***","<span>***</span>")+"<span>\uff08\u533f\u540d\uff09</span>"}j+="</div>";var k="";if(i.tmallSweetPic&&i.tamllSweetLevel){k+='<a href="http://vip.tmall.com" target="_blank" title="\u5929\u732bT'+i.tamllSweetLevel+'\u8fbe\u4eba"><img src="http://a.tbcdn.cn/apps/membermanager/v2/image/'+i.tmallSweetPic+'" /></a>'}k+=this.renderRateIcon(i);if(k){j+='<div class="rate-user-grade">'+k+"</div>"}if(i.attributes&&i.attributes.indexOf("giftBillId")>-1){j+='<div class="rate-gift">\u83b7\u8ba4\u771f\u8bc4\u4ef7\u5956<s></s></div>'}return j};d.renderRateIcon=function(j){var l=j.displayRateSum;if(l<4||!j.displayRatePic){return""}var i=[0,4,11,41,91,151,251,501,1001,2001,5001,10001,20001,50001,100001,200001,500001,1000001,2000001,5000001,10000001];var n=[0,0];var m=0;while(m<i.length&&l>=i[m]){n[0]=i[m];++m;n[1]=i[m]}--m;if(!n[1]){n.pop();n[0]+="\u4ee5\u4e0a"}else{n[1]=(n[1]-1)+"\u4e2a"}var k='<img title="'+n.join(" - ")+'\u4e70\u5bb6\u4fe1\u7528\u79ef\u5206" src="http://a.tbcdn.cn/sys/common/icon/rank_s/'+j.displayRatePic+'" />';if(j.displayUserNumId&&g){k='<a target="_blank" href="http://rate.'+(this.config.daily?"daily.taobao.net":"taobao.com")+"/rate.htm?user_id="+j.displayUserNumId+'&rater=1">'+k+"</a>"}return k};d.renderToolbar=function(){var j=f.now();var i='<span class="rate-filter">';i+='<input class="rate-list-append" id="J_RateWithAppend'+j+'" type="checkbox" name="append" /><label for="J_RateWithAppend'+j+'">\u67e5\u770b\u8ffd\u52a0</label>';i+='<input id="J_RateWithContent'+j+'" type="checkbox" name="content" checked /><label for="J_RateWithContent'+j+'">\u6709\u5185\u5bb9\u8bc4\u4ef7</label>';i+="</span>";i+='<span class="rate-sort">';i+='<a title="\u6309\u8bc4\u4ef7\u65f6\u95f4\u4ece\u8fd1\u5230\u8fdc\u8fdb\u884c\u6392\u5e8f" class="active" href="#" data-value="1"><span class="rate-arrow">\u6309\u65f6\u95f4</span></a>';i+='<a title="\u6309\u4e70\u5bb6\u4fe1\u7528\u7b49\u7ea7\u4ece\u9ad8\u5230\u4f4e\u8fdb\u884c\u6392\u5e8f" href="#" data-value="2"><span class="rate-arrow">\u6309\u4fe1\u7528</span></a>';i+='<a title="\u6309\u8bc4\u4ef7\u5185\u5bb9\u4e30\u5bcc\u7a0b\u5ea6\u8fdb\u884c\u63a8\u8350\u6392\u5e8f" class="rate-sort-recommend" href="#" data-value="3"><span class="rate-arrow">\u6309\u63a8\u8350</span><s class="rate-beta"></s></a>';i+="</span>";return i};d.renderOneTag=function(j,i){return'<span class="tag-'+(j.posi?"posi":"neg")+'"><a id="ratetag'+i+"_"+j.id+(j.posi?"a":"b")+'" href="#" data-posi="'+(j.posi?"1":"-1")+'" data-id="'+j.id+'">'+j.tag+"("+j.count+")<s></s></a></span>"};d.renderTags=function(n){if(!f.isPlainObject(n)||!n.tags){return}var t=this;var v=n.tags;t.renderPersentInfo(v.innerTagCloudList);var o=v.tagClouds;if(!f.isArray(o)||0===o.length){return}var j=[];var i=[];var q=f.guid();t.mm("4.1.1");f.each(o,function(x,w){var y=t.renderOneTag(x,q);x.posi?i.push(y):j.push(y)});var l=i.slice(0,6).join("")+j.slice(0,10).join("");var s=i.join("")+j.join("");var m=h.create('<div class="rate-tag-box"></div>',{html:'<div class="rate-tag-label"><span>\u5927\u5bb6\u90fd\u5199\u5230</span></div><div class="rate-tag-list"><div class="rate-tag-inner">'+l+'</div></div><span class="rate-tag-toggle" title="\u663e\u793a\u6240\u6709\u4fe1\u606f"></span>'});var p=h.get("div.rate-tag-list",m);var r=h.get("div.rate-tag-inner",m);var k=true;var u=h.get("span.rate-tag-toggle",m);c.on(u,"click",function(){var y=t.curTagEl?t.curTagEl.id:"";var w=t.curTagEl?h.outerHTML(t.curTagEl.parentNode):"";r.innerHTML=k?s:l;if(y){var x=h.get("#"+y);if(!x){x=h.create(w);h.prepend(x,r);x=h.get("a",x)}else{if(!k&&h.offset(x.parentNode).top>h.offset(r).top+h.outerHeight(r)){h.prepend(x.parentNode,r)}}c.fire(x,"click")}h.height(p,k?h.outerHeight(r):70);h[k?"addClass":"removeClass"](this,"rate-tag-toggle-expand");k=!k});c.on(r,"click",function(A){A.halt();var w=A.target;if("A"!==w.nodeName){return}var z="1"===h.attr(w,"data-posi");var x="";var y="";t.resetQueryvars();h.removeClass(t.curTagEl,"selected");if(t.curTagEl!==w){h.addClass(w,"selected");t.curTagEl=w;x=z?1:-1;y=h.attr(w,"data-id");t.queryvars.append=0}else{t.curTagEl=null}t.queryvars.tagId=y;t.queryvars.posi=x;t.mm(z?"4.1.2":"4.1.3");t.request()});h.addClass(t.headerEl,"rate-header-tags");t.headerEl.appendChild(m);if(h.outerHeight(r)>70){u.style.visibility="visible"}};d.renderPersentInfo=function(l){if(!f.isArray(l)||!l.length||this.config.hasCompose){return}var k="";var i=0;var j=function(n,m){return m.proportion-n.proportion};f.each(l,function(n,m){var p=n.total;var q=n.tagScaleList;var o={};i+=p;f.each(f.clone(q).sort(j),function(s,r){o[s.scale]=r});k+='<div class="rate-theme rate-theme-'+m+'"><h5>'+n.dimenName+"\uff1a</h5><ol>";f.each(q,function(u){if(!u.count){return}var w=u.scale;var x=o[w];var v=w+":"+u.proportion+"%";var r="theme-opt-"+x;var t="width:"+u.proportion+"%";var s=x?"&nbsp;":(u.proportion+"%");k+='<li title="'+v+'" class="'+r+'" style="'+t+'"><s></s><span>'+w+"</span>"+s+"</li>"});k+="</ol></div>"});if(20>i){return}this.subjectEl.innerHTML='<h4>\u5927\u5bb6\u8ba4\u4e3a</h4><div class="rate-theme-list">'+k+"</div>";this.subjectEl.style.display="block";f.each(h.query("ol",this.subjectEl),function(m){f.each(h.query("li",m).reverse(),function(r,o){var u=h.get("s",r);var n=h.get("span",r);var q=h.outerWidth(r);h.css(u,"left",(q-h.outerWidth(u))/2);var p=h.outerWidth(n);var s=(q-p)/2;var t=p+s-q;if(o&&t>0){t-=parseFloat(h.css(h.get("span",h.next(r)),"left"),10)-6;if(t>0){s-=t}}h.css(n,"left",s)})})};d.initListEvents=function(){var i=this;c.on(h.query("a",i.pageEl),"click",function(j){j.halt();var k=h.attr(this,"data-page")||this.innerHTML;if(k){i.queryvars.currentPage=k;i.request(function(){h.scrollTop(h.offset(i.toolbarEl).top-50)})}})};d.detachEvents=function(){c.detach(h.query("a",this.pageEl),"click")};function a(i){return i.replace(/(\\n|\\r)+/g,"<br/>")}return d},{requires:["dom","event","ajax","anim"]});/*pub-1|2013-05-17 20:32:29*/KISSY.add("tml/review/index",function(a,b){var c={};c.init=function(g,e){var d=this;g=b.get(g);var f={daily:e.daily,width:e.width,tbtoken:e.tbtoken,sellerId:e.sellerId,tokenLoader:e.tokenLoader};g.innerHTML='<div class="rate-header"></div><div class="rate-compose"></div><div class="rate-subject"></div><div class="rate-toolbar"></div><div class="rate-grid"></div><div class="rate-page"></div>';if(e.width){b.addClass(g,"rate-w"+e.width)}b.addClass(g,"tm-rate");if(e.compose){f.hasCompose=true;a.use("tml/review/compose",function(h,i){i.init(g,h.merge(f,e.compose))})}if(e.list){a.use("tml/review/list",function(i,h){h.init(g,i.merge(f,e.list),e.hasUserLink)})}};return c},{requires:["dom"]});