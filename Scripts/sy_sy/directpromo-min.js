KISSY.add("tml/directpromo",function(c){var n="http://delta.taobao.com/home/delivery/AllContentByPage.do?resourceIds=",e="J_DirectPromo",f="J_DirectPromo_",i="data-resid",d="__content_results",a=/^https?:\/\/\S+$/i,h=/^https?:\/\/\S+(png|jpg|gif)$/i,j=window,q,l=[],g,m={},p=[];var o={success:"success",error:"error",render:"render"};if(j.g_config&&g_config.directIds){q=g_config.directIds}function b(u,s){var r=u.length,t;while(r--){t=u[r];!c.inArray(t,s)&&s.push(t)}return s}var k=c.merge(c.EventTarget,{init:function(s){var r=this;c.ready(function(){var t=c.query("."+e),u=[],v;if(!t||t.length===0){return}c.each(t,function(w){v=parseInt(w.getAttribute(i));if(v&&!isNaN(v)){u.push(v);m[v]=w}});s&&(u=b(s,u));q&&(u=b(q,u));if(!g){j[d]&&u.toString()===l.toString()?r.render():r._request(u)}else{k.on(o.success,function(){u.toString()===l.toString()?r.render():r._request(u)})}})},_request:function(t){var s=this,r=n+t.join(",")+"&t="+ +new Date;if(~location.search.indexOf("preview=preview")){r+="&preview=preview"}l=t;g=true;c.getScript(r,{success:function(){var u=j[d];if(!u||u.length===0){return}p=p.concat(u);k.fire(o.success,{data:u});s.render();g=false},error:function(){c.error("direct promotion request faild !");k.fire(o.error);g=false}})},render:function(){c.log("direct promotion start render ...");var s=p.length,t,r,u;while(s--){t=p[s];u=t.id;k.fire(o.render,{id:u,data:t});if(!m[u]){r=c.get("#"+f+u);if(r){m[u]=r}else{continue}}p.splice(s,1);this._fill(t)}},_fill:function(v){var r=m[v.id],u=v.content,t=v.link,s;if(!r||!u){return}if(h.test(u)){s='<img src="'+u+'" />'}else{if(u=="http://tms.tms.tms"){return}else{if(a.test(u)){s='<iframe src="'+u+'" scrolling="no" frameborder="0" width="330" height="200"></iframe>';t=""}else{s=u}}}r.innerHTML=t?'<a target="_blank" href="'+t+'">'+s+"</a>":s}});return k});